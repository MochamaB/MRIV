@using MRIV.Enums
@using MRIV.Helpers
@using MRIV.ViewModels
@model IEnumerable<MRIV.ViewModels.EmployeeViewModel>

@{

    ViewData["Title"] = "Employees";
    var departmentNames = ViewBag.DepartmentNames as Dictionary<string, string>;
    var stationNames = ViewBag.StationNames as Dictionary<string, string>;
    var pagination = ViewBag.Pagination as MRIV.ViewModels.PaginationViewModel;
    var totalCount = ViewBag.TotalCount;
    var startNumber = ((pagination.CurrentPage - 1) * pagination.ItemsPerPage) + 1;
    var currentSortField = ViewBag.SortField;
    var currentSortOrder = ViewBag.SortOrder;
    var searchTerm = ViewBag.SearchTerm as string;

    var counter = 1;

    // Get filter values from query string
    var departmentFilter = ViewBag.DepartmentFilter as string ?? Context.Request.Query["Department"].ToString();
    var stationFilter = ViewBag.StationFilter as string ?? Context.Request.Query["Station"].ToString();
    var roleFilter = ViewBag.RoleFilter as string ?? Context.Request.Query["Role"].ToString();
    var designationFilter = ViewBag.DesignationFilter as string ?? Context.Request.Query["Designation"].ToString();
    
    // Helper function to generate sort URL
    Func<string, string> GetSortUrl = (string field) => {
        var newSortOrder = field.Equals(currentSortField, StringComparison.OrdinalIgnoreCase) && currentSortOrder == "asc" ? "desc" : "asc";
        return Url.Action("Index", "Employees", new { 
            page = pagination.CurrentPage, 
            sortField = field, 
            sortOrder = newSortOrder, 
            searchTerm = ViewBag.SearchTerm,
            Department = ViewBag.DepartmentFilter,
            Station = ViewBag.StationFilter,
            Role = ViewBag.RoleFilter,
            Designation = ViewBag.DesignationFilter
        });
    };

    
    // Helper function to get sort icon
    Func<string, string> GetSortIcon = (string field) => {
        if (!field.Equals(currentSortField, StringComparison.OrdinalIgnoreCase))
            return "mdi mdi-sort text-muted";
            
        return currentSortOrder == "asc" ? "mdi mdi-sort-ascending text-success" : "mdi mdi-sort-descending text-danger";
    };
    var roleBadges = new Dictionary<string, (string Label, string Css)>(StringComparer.OrdinalIgnoreCase)
    {
        { "Deactivated", ("Deactivated", "badge bg-danger-subtle text-danger") },
        { "Admin", ("Admin", "badge bg-primary-subtle text-primary") },
        { "HR", ("HR", "badge bg-info-subtle text-info") },
        { "Hod", ("HOD", "badge bg-warning-subtle text-warning") },
        { "Supervisor", ("Supervisor", "badge bg-secondary-subtle text-secondary") },
        { "User", ("User", "badge bg-dark-subtle text-dark") },
        { "2_step_mgrs", ("2 Step Managers", "badge bg-success-subtle text-success") },
        { "2_step_secs", ("2 Step Secretaries", "badge bg-success-subtle text-success") },
        { "FieldUser", ("Field User", "badge bg-primary-subtle text-primary") },
        { "FieldSupervisor", ("Field Supervisor", "badge bg-secondary-subtle text-secondary") }
    };

}

<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header border-bottom-dashed" style="padding:1rem 0rem">
                <div class="d-flex align-items-center">
                    <h5 class="card-title mb-0 flex-grow-1">Employees (@totalCount total)</h5>
                    <div class="flex-shrink-0">
                        <div class="d-flex gap-2 flex-wrap">
                            <div class="search-box">
                                <input type="text" class="form-control search" placeholder="Search..." value="@searchTerm">
                                <i class="ri-search-line search-icon"></i>
                            </div>

                            <!-- Filter Toggle Button -->
                            @await Html.PartialAsync("_FilterToggleButton")

                            <a href="@Url.Action("Create", "Employees")" class="btn btn-primary btn-sm d-flex align-items-center py-2">
                                <i class="ri-add-line align-bottom me-1"></i> Add Employee
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters Partial View -->
            @await Html.PartialAsync("_Filters", (FilterViewModel)ViewBag.Filters)

            <!-- Table Content -->
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered align-middle mb-0 table-hover">
                        <thead>
                            <tr class="table-light">
                                <th></th>
                                <th>
                                    <a href="@GetSortUrl("Fullname")" class="d-flex align-items-center text-primary">
                                        Employee
                                        <i class="@GetSortIcon("Fullname") ms-1"></i>
                                    </a>
                                </th>
                                <th>
                                    <a href="@GetSortUrl("StationCategory")" class="d-flex align-items-center text-primary">
                                        Designation
                                        <i class="@GetSortIcon("StationCategory") ms-1"></i>
                                    </a>
                                </th>
                                <th>
                                    <a href="@GetSortUrl("Station")" class="d-flex align-items-center text-primary">
                                        Station
                                        <i class="@GetSortIcon("Station") ms-1"></i>
                                    </a>
                                </th>
                                <th>
                                    <a href="@GetSortUrl("Department")" class="d-flex align-items-center text-primary">
                                        Department
                                        <i class="@GetSortIcon("Department") ms-1"></i>
                                    </a>
                                </th>
                                <th>
                                    <a href="@GetSortUrl("PayrollNo")" class="text-primary">
                                        Payroll No
                                        <i class="@GetSortIcon("PayrollNo") ms-1"></i>
                                    </a>
                                </th>
                                <th>
                                    <a href="@GetSortUrl("Role")" class="d-flex align-items-center text-primary">
                                        Role
                                        <i class="@GetSortIcon("Role") ms-1"></i>
                                    </a>
                                </th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.Any())
                            {
                                foreach (var employee in Model)
                                {

                                    <tr class="clickable-row @(employee.EmpisCurrActive != 0 ? "text-muted" : "")" data-href="@Url.Action("Details", "Employees", new { id = employee.PayrollNo, rollNo = employee.RollNo })">
                                        <!-- Employee Column with Profile Initials, Name and Email -->
                                        <td>@counter</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-sm bg-primary rounded-circle d-flex align-items-center justify-content-center me-3">
                                                    <span class="text-white fw-bold">@employee.Initials</span>
                                                </div>
                                                <div>
                                                    <div class="fw-bold">
                                                        <a href="@Url.Action("Details", "Employees", new { id = employee.PayrollNo, rollNo = employee.RollNo })" class="text-decoration-none @(employee.EmpisCurrActive != 0 ? "text-muted" : "text-dark")">
                                                            @employee.FullName
                                                        </a>
                                                    </div>
                                                    @if (!string.IsNullOrEmpty(employee.EmailAddress))
                                                    {
                                                        <small class="text-muted">@employee.EmailAddress</small>
                                                    }
                                                   
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(employee.Designation))
                                            {
                                                <div><small class="text-success">@employee.Designation</small></div>
                                            }
                                        </td>
                                        
                                       
                                   
                                        <!-- Station Column -->
                                        <td>
                                            @if (!string.IsNullOrEmpty(employee.StationCategoryName))
                                            {
                                                <div class="fw-medium">@employee.StationCategoryName</div>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                            @if (!string.IsNullOrEmpty(employee.StationName))
                                            {
                                               <small class="text-muted">@employee.StationName</small>
                                                @if (!string.IsNullOrEmpty(employee.Station) && employee.Station != employee.StationName)
                                                {
                                                    <small class="text-muted">(@employee.Station)</small>
                                                }
                                            }
                                            else if (!string.IsNullOrEmpty(employee.Station))
                                            {
                                                <span>@employee.Station</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        
                                        <!-- Department Column -->
                                        <td>
                                            @if (!string.IsNullOrEmpty(employee.DepartmentName))
                                            {
                                                <div class="fw-medium">@employee.DepartmentName</div>
                                                @if (!string.IsNullOrEmpty(employee.Department) && employee.Department != employee.DepartmentName)
                                                {
                                                    <small class="text-muted">(@employee.Department)</small>
                                                }
                                            }
                                            
                                        </td>
                                        
                                        <!-- Payroll No Column -->
                                        <td>
                                            <span class="fw-bold text-primary @(employee.EmpisCurrActive != 0 ? "text-muted" : "")">
                                                @employee.PayrollNo
                                            </span>
                                        </td>
                                        
                                        <!-- Role Column -->
                                        <td>
                                            @{
                                                var role = !string.IsNullOrEmpty(employee.Role) && roleBadges.ContainsKey(employee.Role)
                                                ? roleBadges[employee.Role]
                                                : ("Unknown", "badge bg-light text-muted");
                                            }
                                            <span class="@role.Item2">@role.Item1</span>
                                        </td>
                                        
                                        <!-- Actions Dropdown -->
                                        <td>
                                            <div class="dropdown">
                                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                    <i class="mdi mdi-dots-vertical"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li>
                                                        <a class="dropdown-item" href="@Url.Action("Details", "Employees", new { id = employee.PayrollNo, rollNo = employee.RollNo })">
                                                            <i class="mdi mdi-eye-outline me-2"></i>View Details
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a class="dropdown-item" href="@Url.Action("Edit", "Employees", new { id = employee.PayrollNo, rollNo = employee.RollNo })">
                                                            <i class="mdi mdi-pencil-outline me-2"></i>Edit
                                                        </a>
                                                    </li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li>
                                                        <span class="dropdown-item-text">
                                                            <small class="text-muted">
                                                                Status: <span class="badge @employee.StatusClass">@employee.StatusBadge</span>
                                                            </small>
                                                        </span>
                                                    </li>
                                                </ul>
                                            </div>
                                        </td>
                                    </tr>
                                    counter++;
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="7" class="text-center">
                                        @if (!string.IsNullOrEmpty(searchTerm) || !string.IsNullOrEmpty(departmentFilter) || !string.IsNullOrEmpty(stationFilter) || !string.IsNullOrEmpty(roleFilter))
                                        {
                                            <div class="p-3">
                                                <div class="text-center">
                                                    <i class="ri-search-line display-5 text-muted"></i>
                                                    <h5 class="mt-2">No results found for the current filters</h5>
                                                    <p class="text-muted">Try adjusting your search criteria</p>
                                                </div>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="p-3">No employees found.</div>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                @if (pagination.TotalItems > pagination.ItemsPerPage)
                {
                    <div class="d-flex justify-content-end mt-3">
                        <nav aria-label="Page navigation">
                            <ul class="pagination">
                                @if (pagination.CurrentPage > 1)
                                {
                                    <li class="page-item">
                                        <a class="page-link" href="@Url.Action(pagination.Action, pagination.Controller, new { page = 1, sortField = currentSortField, sortOrder = currentSortOrder, searchTerm = ViewBag.SearchTerm, Department = ViewBag.DepartmentFilter, Station = ViewBag.StationFilter, Role = ViewBag.RoleFilter, Designation = ViewBag.DesignationFilter })" aria-label="First">
                                            <span aria-hidden="true">&laquo;&laquo;</span>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="@Url.Action(pagination.Action, pagination.Controller, new { page = pagination.CurrentPage - 1, sortField = currentSortField, sortOrder = currentSortOrder, searchTerm = ViewBag.SearchTerm, Department = ViewBag.DepartmentFilter, Station = ViewBag.StationFilter, Role = ViewBag.RoleFilter, Designation = ViewBag.DesignationFilter })" aria-label="Previous">
                                            <span aria-hidden="true">&laquo;</span>
                                        </a>
                                    </li>
                                }

                                @{
                                    int totalPages = (int)Math.Ceiling((double)pagination.TotalItems / pagination.ItemsPerPage);
                                    int startPage = Math.Max(1, pagination.CurrentPage - 2);
                                    int endPage = Math.Min(totalPages, startPage + 4);
                                    startPage = Math.Max(1, endPage - 4);
                                }

                                @for (int i = startPage; i <= endPage; i++)
                                {
                                    <li class="page-item @(i == pagination.CurrentPage ? "active" : "")">
                                        <a class="page-link" href="@Url.Action(pagination.Action, pagination.Controller, new { page = i, sortField = currentSortField, sortOrder = currentSortOrder, searchTerm = ViewBag.SearchTerm, Department = ViewBag.DepartmentFilter, Station = ViewBag.StationFilter, Role = ViewBag.RoleFilter, Designation = ViewBag.DesignationFilter })">@i</a>
                                    </li>
                                }

                                @if (pagination.CurrentPage < totalPages)
                                {
                                    <li class="page-item">
                                        <a class="page-link" href="@Url.Action(pagination.Action, pagination.Controller, new { page = pagination.CurrentPage + 1, sortField = currentSortField, sortOrder = currentSortOrder, searchTerm = ViewBag.SearchTerm, Department = ViewBag.DepartmentFilter, Station = ViewBag.StationFilter, Role = ViewBag.RoleFilter, Designation = ViewBag.DesignationFilter })" aria-label="Next">
                                            <span aria-hidden="true">&raquo;</span>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="@Url.Action(pagination.Action, pagination.Controller, new { page = totalPages, sortField = currentSortField, sortOrder = currentSortOrder, searchTerm = ViewBag.SearchTerm, Department = ViewBag.DepartmentFilter, Station = ViewBag.StationFilter, Role = ViewBag.RoleFilter, Designation = ViewBag.DesignationFilter })" aria-label="Last">
                                            <span aria-hidden="true">&raquo;&raquo;</span>
                                        </a>
                                    </li>
                                }
                            </ul>
                        </nav>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            })

            // Toggle filter section
            $("#toggleFilters").click(function () {
                $("#filterSection").slideToggle();
                $(this).find("i").toggleClass("mdi-chevron-down mdi-chevron-up");
            });
            
            // Make rows clickable
            $(".clickable-row").click(function(e) {
                // Don't navigate if clicking on a link or button
                if (!$(e.target).is('a') && !$(e.target).is('button') && 
                    !$(e.target).parent().is('a') && !$(e.target).parent().is('button') &&
                    !$(e.target).hasClass('mdi') && !$(e.target).parent().hasClass('mdi')) {
                    window.location = $(this).data("href");
                }
            });
            
            // Add hover effect to clickable rows
            $(".clickable-row").hover(
                function() {
                    $(this).addClass('table-hover-custom');
                },
                function() {
                    $(this).removeClass('table-hover-custom');
                }
            );
        });
    </script>
    
    <style>
        .clickable-row {
            cursor: pointer;
        }
        
        .table-hover-custom {
            background-color: rgba(0, 123, 255, 0.05) !important;
        }
        
        .badge {
            font-size: 85%;
            font-weight: 500;
            padding: 0.35em 0.65em;
        }
        
        .avatar-sm {
            width: 40px;
            height: 40px;
            font-size: 14px;
        }
        
        .bg-info-subtle {
            background-color: rgba(13, 202, 240, 0.1) !important;
        }
        
        .bg-success-subtle {
            background-color: rgba(25, 135, 84, 0.1) !important;
        }
        
        .text-info {
            color: #0dcaf0 !important;
        }
        
        .text-success {
            color: #198754 !important;
        }
    </style>
}
